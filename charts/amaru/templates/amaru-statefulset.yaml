{{ range $attributes := .Values.nodes }}
{{ if $attributes.enabled }}
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "amaru-{{ $attributes.name }}"
spec:
  replicas: {{ $attributes.replicas }}
  serviceName: "amaru-{{ $attributes.name }}"
  selector:
    matchLabels:
      app: amaru
      name: {{ $attributes.name }}
      type: {{ $attributes.type }}
      network: {{ $.Values.network }}
  template:
    metadata:
      labels:
        app: amaru
        name: {{ $attributes.name }}
        type: {{ $attributes.type }}
        network: {{ $.Values.network }}
    spec:
      initContainers:
        - name: init
          command: [ "bash", "-x", "/configmap/init.sh" ]
          image: "{{ $attributes.repository | default $.Values.image.repository }}:{{ $attributes.imageTag | default $.Values.image.tag }}"
          env:
            - name: SKIP_BOOTSTRAP
              value: {{ $attributes.sleep | quote }}
            - name: NETWORK
              value: {{ $.Values.network }}
            - name: AMARU_LEDGER_DIR
              value: {{ $.Values.config.ledgerDir }}
            - name: AMARU_CHAIN_DIR
              value: {{ $.Values.config.chainDir }}
            - name: CONFIG_FOLDER
              value: {{ $.Values.config.configFolder }}
          imagePullPolicy: "Always"
          volumeMounts:
            - name: "amaru-{{ $attributes.name }}"
              mountPath: /data/db
            - name: "amaru-init"
              mountPath: /configmap
      containers:
        - name: amaru
          {{- if $attributes.sleep }}
          command: [ "/bin/bash", "-c", "--" ]
          args: [ "sleep 999999" ]
          {{- else }}
          command: [ "amaru" ]
          args:
            - "run"
            - "--network"
            - "$(NETWORK)"
            - "--peer-address"
            - "$(AMARU_PEER_ADDRESS)"
            - "--ledger-dir"
            - "$(AMARU_LEDGER_DIR)"
            - "--chain-dir"
            - "$(AMARU_CHAIN_DIR)"
          {{- end }}
          image: "{{ $attributes.repository | default $.Values.image.repository }}:{{ $attributes.imageTag | default $.Values.image.tag }}"
          env:
            - name: NETWORK
              value: {{ $.Values.network }}
            - name: AMARU_PEER_ADDRESS
              value: {{ $attributes.peerAddress }}
            - name: AMARU_LEDGER_DIR
              value: {{ $.Values.config.ledgerDir }}
            - name: AMARU_CHAIN_DIR
              value: {{ $.Values.config.chainDir }}
              {{- $collectorConfig := $attributes.otelCollector | default $.Values.otelCollector }}
              {{- if or $attributes.withOpenTelemetry $collectorConfig.enabled }}
            - name: AMARU_WITH_OPEN_TELEMETRY
              value: "true"
            - name: AMARU_OTLP_METRIC_URL
              {{- if $collectorConfig.enabled }}
              value: "http://localhost:{{ $collectorConfig.otlpHttpPort | default 4318 }}/v1/metrics"
              {{- else }}
              value: {{ $attributes.otlpMetricUrl | default "http://otel-collector-opentelemetry-collector.observe:4318/v1/metrics" }}
              {{- end }}
            - name: AMARU_OTLP_SPAN_URL
              {{- if $collectorConfig.enabled }}
              value: "http://localhost:{{ $collectorConfig.otlpGrpcPort | default 4317 }}"
              {{- else }}
              value: {{ $attributes.otlpSpanUrl | default "http://otel-collector-opentelemetry-collector.observe:4317" }}
              {{- end }}
            - name: AMARU_OTLP_SERVICE_NAME
              value: "amaru"
              {{- end }}
          ports:
            - name: node
              containerPort: {{ $attributes.port }}
            - name: prom
              containerPort: {{ $attributes.prometheusPort | default 12798 }}
          {{- with $attributes.resources | default $.Values.resources }}
          resources:
{{ toYaml . | indent 12 }}
          {{- end }}
          volumeMounts:
            - name: "amaru-{{ $attributes.name }}"
              mountPath: /data/db
        {{- $collectorConfig := $attributes.otelCollector | default $.Values.otelCollector }}
        {{- if $collectorConfig.enabled }}
        - name: otel-collector
          image: "{{ dig "image" "repository" "otel/opentelemetry-collector-contrib" $collectorConfig }}:{{ dig "image" "tag" "latest" $collectorConfig }}"
          imagePullPolicy: {{ dig "image" "pullPolicy" "IfNotPresent" $collectorConfig }}
          args:
            - "--config=/etc/otel-collector/config.yaml"
          ports:
            - name: otlp-grpc
              containerPort: {{ $collectorConfig.otlpGrpcPort | default 4317 }}
              protocol: TCP
            - name: otlp-http
              containerPort: {{ $collectorConfig.otlpHttpPort | default 4318 }}
              protocol: TCP
            - name: prometheus
              containerPort: {{ $collectorConfig.prometheusPort | default 9464 }}
              protocol: TCP
          {{- $collectorResources := dig "resources" dict $collectorConfig }}
          {{- if not $collectorResources }}
          {{- $collectorResources = dig "resources" dict $.Values.otelCollector }}
          {{- end }}
          {{- if $collectorResources }}
          resources:
{{ toYaml $collectorResources | indent 12 }}
          {{- end }}
          volumeMounts:
            - name: otel-collector-config
              mountPath: /etc/otel-collector
              readOnly: true
        {{- end }}
      volumes:
        - name: amaru-init
          configMap:
            name: amaru-init
        {{- $collectorConfig := $attributes.otelCollector | default $.Values.otelCollector }}
        {{- if $collectorConfig.enabled }}
        - name: otel-collector-config
          configMap:
            name: "otel-collector-{{ $attributes.name }}"
        {{- end }}
      terminationGracePeriodSeconds: 180
  volumeClaimTemplates:
  - metadata:
      name: "amaru-{{ $attributes.name }}"
    spec:
      accessModes: [ "ReadWriteOnce" ]
      {{- if $attributes.storageClassName }}
      storageClassName: {{ $attributes.storageClassName }}
      {{- end }}
      resources:
        requests:
          storage: {{ $.Values.volumeSize }}
{{ end }}
{{ end }}